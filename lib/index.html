<!DOCTYPE html>
<html>
<head>
  <script src="keymaster.js"></script>
  <script src="utils.js"></script>
  <script src="movingObject.js"></script>
  <script src="asteroid.js"></script>
  <script src="bullets.js"></script>
  <script src="ship.js"></script>
  <script src="game.js"></script>
  <script src="gameView.js"></script>
  <script src="mouse.js"></script>
  <script src="jquery-2.1.1.js"></script>

  <link rel="stylesheet" type="text/css" href="asteroids.css">

</head>
  <body>

    <main>
      <h1 class="title">Asteroids</h1>
      <h2 class="newGame">New Game</h2>
      <h2 class="setting">Settings</h2>
      <canvas id="game-canvas"></canvas>
    </main>

    <canvas id="analyser_render"></canvas>

    <h2 class="restart">Restart</h2>

    <script>
      var playAudio = new Audio("music/test.mp3");
      var menuAudio = new Audio("music/menu.mp3")
        menuAudio.addEventListener('ended', function() {
          this.currentTime = 0;
          this.play();
        }, false);
        playAudio.addEventListener('ended', function() {
          this.currentTime = 0;
          this.play();
        }, false);
      menuAudio.oncanplaythrough = menuAudio.play();

      // misha mishenko - Vakning að elska
      // Misha Mishenko - Vor í mig

    window.addEventListener("load", initMp3Player, false);
    function initMp3Player(){
      var context = new AudioContext();
      var analyser = context.createAnalyser();
      var canvas = $('#analyser_render')[0];
      var ctx = canvas.getContext('2d');
      var source = context.createMediaElementSource(menuAudio);
      source.connect(analyser);
      analyser.connect(context.destination);
      frameLooper(analyser, ctx, canvas); }

    function frameLooper(analyser, ctx, canvas){ 
      requestID = window.requestAnimationFrame(frameLooper.bind(null, analyser, ctx, canvas));
      var fbc_array = new Uint8Array(analyser.frequencyBinCount);
      analyser.getByteFrequencyData(fbc_array);
      $('#analyser_render').height($("main").height() - 350)
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#00CCFF';
      var bars = 100;
      for (var i = 0; i < bars; i++) { 
        var bar_x = i * Math.floor(canvas.width/bars);
        var bar_width = 2;
        var bar_height = -(fbc_array[i] * (Math.sqrt(($('#analyser_render').height())) / 50));
         ctx.fillRect(bar_x, canvas.height, bar_width, bar_height);
      }
    }

      
      $(".newGame").on("click", function () {
        window.canvasEl = document.getElementById("game-canvas");
        window.canvasHeight = canvasEl.height = window.innerHeight;
        window.canvasWidth = canvasEl.width = window.innerWidth;
        window.ctx = canvasEl.getContext("2d");
        if (typeof window.ast === "undefined") {
          window.ast = new Asteroids.GameView(ctx, canvasHeight, canvasWidth);
        }

        ast.game = new Asteroids.Game(canvasWidth, canvasHeight);
        window.cancelAnimationFrame(requestID)
        $("canvas").toggleClass("playtime");
        $("main").toggleClass("playtime");
        menuAudio.pause();
        playAudio.oncanplaythrough = playAudio.play();
        ast.start();
      })
    </script>
  </body>
</html>